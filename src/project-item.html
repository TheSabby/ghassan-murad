<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">

<dom-module id="project-item">
  <template>
    <style include="iron-flex iron-flex-alignment iron-flex-factors">
      :host {
        display: block;
        box-sizing: border-box;
        margin: 16px 0;
        position: relative;
        transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        min-height: 340px;
      }

      .container {
        background-color: #fff;
        border-radius: 3px;
      }

      .main-container {
        background-position: center;
        background-repeat: no-repeat;
        background-size: cover;
        position: absolute;
        overflow: hidden;
        z-index: 10;
        height: 100%;
        cursor: pointer;
        width: 100%;
        opacity: 1;
        transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .main-text-area {
        position: absolute;
        right: 0;
        top: 0;
        height: 100%;
        overflow: hidden;
        background-color: rgba(0,0,0,0.7);
        /*transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);*/
        width: 33%;
        /*right: -33%;*/
      }

      .main-text {
        color: #fff;
        box-sizing: border-box;
        margin: 16px;
      }

      .project-items {
        overflow: hidden;
        border-radius: 3px;
        height: 340px;
        transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .project-item-row {
        position: relative;
        width: 100%;
        transition: margin 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .project-item {
        background-color: var(--app-secondary-color);
        border-radius: 3px;
        height: 340px;
        transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        width: 300px;
        cursor: pointer;
        margin-right: 20px;
        background-position: center;
        background-repeat: no-repeat;
        background-size: cover;
        overflow: scroll;
        position: relative;
      }

      .project-item:last-of-type {
        margin-right: 0;
      }

      .project-item-text {
        padding: 16px;
        color: var(--app-primary-color);
        font-family: 'Cairo', 'Roboto', 'Noto', sans-serif;
        font-size: 0.8rem;
      }

      .project-next-btn {
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        background-color: rgba(0,0,0,0.4);
        display: flex;
        text-align: center;
        align-items: center;
        justify-content: center;
      }
    </style>
    <div class="project vertical layout">
      <paper-material
        id="main_container"
        class="main-container container"
        elevation="2"
        on-click="openProject">
        <div id="main_text_area" class="main-text-area">
          <div class="main-text">{{description}}</div>
        </div>
      </paper-material>
      <paper-material id="project_items" elevation="1" class="project-items vertical layout justified"></paper-material>
    </div>
  </template>

  <script>
    ProjectItem = Polymer({
      is: 'project-item',

      properties: {
        showcaseImage: String,
        mainTextShown: {
          type: Boolean,
          value: false
        },
        description: String,
        textWidth: String,
        originalWidth: String,
        projectData: Array,
        projectWidth: String,
        projectLength: Number,
        projectPage: {
          type: Number,
          value: 0
        }
      },

      factoryImpl: function(project) {
        console.log(project);
        this.showcaseImage = project.showcase_image;
        this.description = project.description;
        this.textWidth = project.text_width;
        this.projectWidth = project.width;
        this.projectData = project.project_data;
        this.projectLength = this.projectData.length;

        this.renderProject();
      },

      openProject: function() {
        this.fire('project-clicked', {project: this});
      },

      splitProject: function() {
        var project = this;
        project.originalWidth = $(project).css('width');
        $(project).css('width', '100%');
        $(project.$.main_container).css('opacity', '0');
        setTimeout(function() {
          $(project.$.project_items).css('height', '350px');
          $(project.$.main_container).css('display', 'none');
          var rowCount = Polymer.dom(project.$.project_items).querySelectorAll('.project-item-row').length;
          Polymer.dom(project.$.project_items).querySelectorAll('.project-item-row').forEach(function(row) {
            var itemCount = Polymer.dom(row).querySelectorAll('.project-item').length;
            Polymer.dom(row).querySelectorAll('.project-item').forEach(function(item, index) {
              if(index != itemCount - 1) {
                $(item).css('margin-right', '20px');
              }
              $(item).css('border-radius', '3px');
              item.elevation = 2;
            });
          });
          project.$.project_items.elevation = 0;
          project.renderRows();
        }, 300);
      },

      renderRows: function() {
        var project = this;
        for(var i = 1; i < project.projectLength; i++) {
          var row = this.projectData[i];
          var row_container = document.createElement('div');
          row_container.className = 'project-item-row horizontal layout justified';
          Polymer.dom(this.$.project_items).appendChild(row_container);
          row.forEach(function(item) {
            var row_item = document.createElement('paper-material');
            row_item.className = 'project-item container';
            if(item.width_type == 'flex') {
              row_item.className += ' ' + item.width;
            } else if(item.width_type == 'percentage') {
              $(row_item).css('width', item.width);
            }

            if(item.type == 'image') {
              $(row_item).css('background-image', 'url(' + item.content + ')');
            } else if(item.type == 'text') {
              var row_item_text = document.createElement('div');
              row_item_text.innerHTML = item.content;
              row_item_text.className = 'project-item-text';
              Polymer.dom(row_item).appendChild(row_item_text);
            }

            row_item.elevation = 2;
            row_item.animated = true;
            Polymer.dom(row_container).appendChild(row_item);
          });

          $(row_container).css('top', (+$(row_container).height() + 30) + 'px');
        }
      },

      closeProject: function() {
        var project = this;
        Polymer.dom(project.$.project_items).querySelectorAll('.project-item-row').forEach(function(row) {
          Polymer.dom(row).querySelectorAll('.project-item').forEach(function(item) {
            $(item).css('margin-right', '0');
            $(item).css('border-radius', '0');
            item.elevation = 0;
          });
        });
        $(project.$.project_items).css('height', '340px');
        project.$.project_items.elevation = 2;
        $(project.$.main_container).css('display', 'block');
        setTimeout(function() {
          $(project).css('width', project.originalWidth);
          $(project.$.main_container).css('opacity', '1');
          Polymer.dom(project.$.project_items).innerHTML = '';
          project.renderFirstRow();
        }, 300);
      },

      renderProject: function() {
        $(this).css('width', this.projectWidth);
        $(this.$.main_container).css('background-image', 'url(' + this.showcaseImage + ')');
        $(this.$.main_text_area).css('width', this.textWidth);
        $(this.$.main_text_area).css('right', '-' + this.textWidth);

        this.renderFirstRow();
      },

      renderFirstRow: function() {
        if(this.projectLength > 0) {
          var firstRow = this.projectData[0];
          var row_container = document.createElement('div');
          row_container.className = 'project-item-row horizontal layout flex';
          Polymer.dom(this.$.project_items).appendChild(row_container);
          firstRow.forEach(function(item) {
            var row_item = document.createElement('paper-material');
            row_item.className = 'project-item container';
            if(item.width_type == 'flex') {
              row_item.className += ' ' + item.width;
            } else if(item.width_type == 'percentage') {
              $(row_item).css('width', item.width);
            }

            if(item.type == 'image') {
              $(row_item).css('background-image', 'url(' + item.content + ')');
            } else if(item.type == 'text') {
              var row_item_text = document.createElement('div');
              row_item_text.innerHTML = item.content;
              row_item_text.className = 'project-item-text';
              Polymer.dom(row_item).appendChild(row_item_text);
            }

            row_item.elevation = 0;
            row_item.animated = true;
            $(row_item).css('margin-right', '0');
            $(row_item).css('border-radius', '0');
            Polymer.dom(row_container).appendChild(row_item);
          });
        }
      },

      showMainText: function() {
        if(!this.mainTextShown) {
          $(this.$.main_text_area).css('right', '0');
          this.mainTextShown = true;
        }
      },

      hideMainText: function() {
        if(this.mainTextShown) {
          $(this.$.main_text_area).css('right', '-' + this.textWidth);
          this.mainTextShown = false;
        }
      }
    });
  </script>
</dom-module>
